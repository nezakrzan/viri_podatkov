---
title: "Seminarska naloga"
author: "Neža Kržan, Tom Rupnik"
output:
  pdf_document:
    number_sections: true
    fig_caption: true
header-includes:
- \usepackage[slovene]{babel}
- \usepackage{float}
- \usepackage[T1]{fontenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.pos = "H", out.extra = "", fig.height = 4, fig.width = 5, fig.align = 'center')

# install.packages("readxl")

library(readxl)
library(astsa)
library(car)
```

\tableofcontents
\listoffigures
\listoftables
\newpage

```{r}
# imena posameznih sheet-ov
# excel_sheets("Podatki za seminarske naloge.xlsx")

# Prosta in zasedena delovna mest
data1 = read_excel("Podatki za seminarske naloge.xlsx",
                   sheet = "Prosta in zasedena delovna mest")
# Indeks prihodka po dejavnostih
data2 = read_excel("Podatki za seminarske naloge.xlsx",
                   sheet = "Indeks prihodka po dejavnostih")

zasedena_1 = data1[,"Zasedena_1+_I GOSTINSTVO"]
prosta_1 = data1[,"Prosta_1+_I GOSTINSTVO"]

nastanitvene_dejavnosti = data2[,"Gostinske nastanitvene dejavnosti"]
strezba_jedi_pjac = data2[, "Dejavnost strežbe jedi in pijač"]
```

# Uvod

Za analizo sva si izbrala podatke, ki spadajo pod temo _Gostinstvo_. 

Za indeks prihodka po dejavnosti sva si izbrala _Gostinske nastanitvene dejavnosti_ in _Dejavnost strežbe jedi in pijač_. Podatki so podani za časovno obdobje od januarja 2010 do januarja 2024(`2010M01` do `2024M01`). Frekvenca vzorčenja je približno enakomerna in enaka 12, torej gre za mesečno vzročenje. 

Nato sva analiziral še časovni vrsti za prosta in zasedena delovna mesta v gostinstvu, kjer je zaposlena vsaj 1 oseba. Podatki so podani za časovno obdobje od leta 2008 do leta 2023(`2008Q1` do `2023Q4`) po kvartalih. Frekvenca vzorčenja je približno enakomerna in enaka 4, torej gre za četrtletno vzročenje.

Ker sta frekvenci vzorčenja enakomerni imamo opravka z ekvidistantnimi časovnimi vrstami.

# Predstavitev časovnih vrst

```{r}
# casovni interval 2010M1-2024M1
ts_nastanitve = ts(nastanitvene_dejavnosti, start = c(2010,1), frequency = 12)
ts_strezba = ts(strezba_jedi_pjac, start = c(2010,1), frequency = 12)

# preveriva ce je zadnje obdobje res 2024M1
# end(ts_nastanitve)
# end(ts_strezba)

# casovni interval 2028Q1-2023Q4
ts_zasedena = ts(zasedena_1, start = c(2008, 1), frequency = 4)
ts_prosta = ts(prosta_1, start = c(2008, 1), frequency = 4)

# preveriva ce je zadnje obdobje res 2023Q4
# end(ts_zasedena)
# end(ts_prosta)
```

## Časovna vrsta _Gostinske nastanitvene dejavnosti_

```{r fig.dim=c(6,3.7), fig.cap="Časovna vrsta indeksa prihodka za 'Gostinske nastanitvene dejavnosti'."}
plot.ts(ts_nastanitve, type = "o", pch = 16, cex=0.6, xlab = "leto", ylab = "indeks prihodka", xaxt="s")

# gladilnik
gladilnik <- lowess(time(ts_nastanitve),ts_nastanitve)
points(gladilnik$x, gladilnik$y, type="l", col = "blue")
```

V časovni vrsti je prisotnostnih več različnih komponent časovnega procesa. Sprva opazimo trend, ki je najprej nekoliko padajoč, nato pa se proti koncu leta 2014 obrne in postane pozitiven. Dobro je vidna tudi prisotnost sezonskosti. Indeks se v vsakem letu poveča v začetku leta (januarja), nato nekoliko pade in ponovno raste do poletja (avgusta). Potem sledi padanje do konca let, ko je ponovno nekolikšno povišanje decembra. Tako gibanje je bilo tudi pričakovano, saj je to obdobje poletne in zimske sezone. 

Med letoma 2020 in 2022 je opazno neobičajno gibanje vrednosti. Gre namreč za obdobje pandemije Covid-19, ko so veljali izredni ukrepi, ki so vplivali na gostinske nastanitvene dejavnosti. Opazno je vidno tudi povišanje po letu 2022 oz. sprememba v amplitudnem nihanju. Tudi to je verjetno posledica pandemija ovid-19, saj smo se po dolgem času lahko kam odpravili, država pa je pomagala z izdajo t.i. bonov.

## Časovna vrsta _Dejavnost strežbe jedi in pijač_

```{r fig.dim=c(6,3.7), fig.cap="Časovna vrsta indeksa prihodka za 'Dejavnost strežbe jedi in pijač'."}
plot.ts(ts_strezba, type = "o", pch = 16, cex=0.6, xlab = "leto", ylab = "indeks prihodka",  xaxt="s")

# gladilnik
gladilnik <- lowess(time(ts_strezba),ts_strezba)
points(gladilnik$x, gladilnik$y, type="l", col = "blue")
```

Ponovno opazimo prisotnost trenda, ki je čez celotno obdobje naraščajoče, naklon pa je bil največji med letoma 2015 in 2018. Sprva bi glede na vzorec spreminjanja (nihanja) indeksa lahko rekli, da je prisotna sezonskost. Če natančneje pogledamo sta v posameznem letu ekstremni vrednosti poleti in meseca decembra. Do leta 2018 je bila najvišja vrednost indeksa v posameznem letu dosežena decembra, nato pa je bila višja vrednost dosežena poleti. Iz tega bi lahko rekli, da je nekoliko prisotno ciklično nihanje, vendar ni enako čez celotno opazovano obdobje. 

Prav tako je dobro vidno ekstremno gibanje v času pandemije Covid-19, saj se je takrat zgodil velik padec vrednosti indeksa. Tudi aplituda nihanja se je drastično spremenila v primerjavi s predhodnjim opazovanim obdobjem, za kar je verjetno ponovno krivo obnašanje in potrebe ljudi po pandemiji in izdaja državnih bonov.

## Časovna vrsta _Gostinstvo zasedena delovna mesta 1+_

```{r fig.dim=c(6,3.7), fig.cap="Časovna vrsta za zasedena delovna mesta v gostinstvu, kjer je zaposlena vsaj 1 oseba."}
plot.ts(ts_zasedena, type = "o", pch = 16, cex=0.6, xlab = "leto", ylab = "število delovnih mest",  xaxt="n")
axis(1, at=c(2008, 2011, 2014, 2017, 2020, 2023), labels=c("2008", "2011", "2014", "2017", "2020", "2023"))

# gladilnik
gladilnik <- lowess(time(ts_zasedena),ts_zasedena)
points(gladilnik$x, gladilnik$y, type="l", col = "blue")
```

Iz grafa časovne vrste je možno opaziti le priostnost trenda. Ta je sprva strmo pada do leta 2014 nato pa spremeni predznak in začne strmo naraščati. Sezonskosti ni mogoče zaznati, saj so lokalni ekstremi bolj naključni kot, da bi se ponavljali v ciklu. 

Vidna sta, da dva 'ekstremna obdobja'. Hud padec okoli leta 2012, ki je vztrajal do leta 2015, ko si celotno gospodarstvo še vedno ni dobro opomoglo od začetka krize leta 2008 ter okoli leta 2020, ko je bil čas pandemije Covid-19.


## Časovna vrsta _Gostinstvo prosta delovna mesta 1+_

```{r echo=FALSE, fig.cap="Časovna vrsta za prosta delovna mesta v gostinstvu, kjer je zaposlena vsaj 1 oseba.", fig.dim=c(6,3.7)}
plot.ts(ts_prosta, type = "o", pch = 16, cex=0.6, xlab = "leto", ylab = "število delovnih mest",  xaxt="n")
axis(1, at=c(2008, 2011, 2014, 2017, 2020, 2023), labels=c("2008", "2011", "2014", "2017", "2020", "2023"))

# gladilnik
gladilnik <- lowess(time(ts_prosta),ts_prosta)
points(gladilnik$x, gladilnik$y, type="l", col = "blue")
```

Iz grafa časovne vrste je možno opaziti le priostnost trenda. Ta čez celotno opazovano obdobje narašča. Sprva nekoliko bolj položno, po letu 2013 pa se naklon poveča. Sezonskosti ni mogoče zaznati, saj so lokalni ekstremi bolj naključni kot da bi se ponavljali v ciklu. Ponovno pa je vidno ekstrmeno obdobje (čas pandemije Covid-19).


# _Gostinske nastanitvene dejavnosti_

Ponovno narišimo časovno vrsto, ki jo bomo v nadaljevanju podrobneje analizirali.

```{r fig.dim=c(6,3.7), fig.cap="Časovna vrsta indeksa prihodka za 'Gostinske nastanitvene dejavnosti'."}
plot.ts(ts_nastanitve, type = "o", pch = 16, cex=0.6, xlab = "leto", ylab = "indeks prihodka", xaxt="s")

# gladilnik
gladilnik <- lowess(time(ts_nastanitve),ts_nastanitve)
points(gladilnik$x, gladilnik$y, type="l", col = "blue")
```

## Transformacija

Kot smo že ugotovili imamo prisotno nekonstantno variabilnost. Da se prepričamo ali je potrebna transformacija (in tudi kakšna), naredimo box-cox test.

```{r results='hide'}
time = 1 + frequency(ts_nastanitve) * (time(ts_nastanitve) - start(ts_nastanitve)[1])

model_nast1 = lm(ts_nastanitve~ time)
model_nast2 = lm(ts_nastanitve~ time + I(time^2))

# izbereva s kvadratnim ker boljsi
anova(model_nast1, model_nast2)
```

```{r fig.cap="Box-Cox za 'Gostinske nastanitvene dejavnosti'."}
boxCox(model_nast2)
```

Ker je $\lambda = 1$ znotraj intervala zaupanja, to pomeni da transformacija ni potrebna.


## Analiza avtokoreliranosti 

```{r results=FALSE, fig.cap="Avtokorelogram in parcialni avtokorelogram za 'Gostinske nastanitvene dejavnosti'."}
acf2(ts_nastanitve, main = "")
```

Zgornji ACF graf je precej pričakovan, saj sta v časovni vrsti prisotna tako rahel trend kot tudi sezonskost. Trend se izraža s počasnim padanjem verednosti avtokorelacijskih koeficientov z odlogi. Sezona pa je vidna z nihanjem vrednosti koeficientov in izrazitimi vrhovi, ki se ponavljajo.

<!--Tom18: za PACF se ne spomnem zdej nic pametnega-->

S postopnim diferenciranjem bomo najprej odpravili trend nato pa še sezonskost.

```{r fig.dim=c(6,5)}
par(mfrow=c(2,2), oma=c(1,1,0,0))
plot(ts_nastanitve, main="Originalna", xlab="", ylab="")
plot(diff(ts_nastanitve, lag=1), main="Lag=1", xlab="", ylab="")
plot(diff(ts_nastanitve, lag=12), main="Lag=12", xlab="", ylab="")
plot(diff(diff(ts_nastanitve, lag=1),lag=12), main="Lag=1 in Lag=12", xlab="", ylab="")

mtext("leto",side=1,line=0,outer=TRUE,cex=1)
mtext("indeks prihodka",side=2,line=0,outer=TRUE,cex=1,las=0)
```

Na desnem spodnjem grafu (odstranjen trend in sezonskost) vidimo, da je pričakovana vrednost konstantna (enak 0) in variabilnost je končna (se s časom ne povečuje ali zmanjšuje). Torej lahko zaključimo, da imamo stacionarno časovno vrsto

## Izbira ustreznega modela

```{r}
# shraniva si diferencirano casovno vrsto
ts_stac1 = diff(diff(ts_nastanitve, lag=1),lag=12)
```

```{r results=FALSE, fig.cap="Avtokorelogram in parcialni avtokorelogram za stacionarno 'Gostinske nastanitvene dejavnosti'."}
acf2(ts_stac1, main = "")
```

Iz avtokorelograma in parcialnega avtokorelograma vidimo, da je nekaj koeficientov statistično zančilnih (izven 95% intervala). Na podlagi njiju težko ocenimo, za kateri ARMA(p, q) proces gre. Kot največji možni vrednosti za $p$ in $q$ izberemo pmax=12 in qmax=12. 

```{r eval=F, message=FALSE, warning=FALSE, results='hide'}
# dolocimo maksimalno vrednost p in q 

best.order <- c(0, 0, 0)
best.aic <- Inf
pmax <- 12
qmax <- 12
for (i in 0:pmax) {
  for (j in 0:qmax) {
    fit.aic <- AIC(arima(ts_stac1, order = c(i, 0, j)))
    if (fit.aic < best.aic){
      best.order <- c(i, 0, j)
      best.arma <- arima(ts_stac1, order = best.order)
      best.aic <- fit.aic
    }
  }
}
best.order
best.arma
```

Algoritem nam kot model z najnižjo AIC vrednostjo vrne model ARMA(0,12).

```{r results=FALSE, fig.cap="Avtokorelogram in parcialni avtokorelogram 'Gostinske nastanitvene dejavnosti' model ARMA(0,12)."}
# to je ker je zgonji chunk eval=F
best.arma = arima(ts_stac1, order = c(0,0,12))

acf2(best.arma$resid, main = "")
```

Iz zgornjih dveh grafov vidimo, da smo se z modeliranjem $MA(12)$ res znebili koreliranosti (koeficienti pri vseh odlogih so znotraj 95% intervala zaupanja).


# _Dejavnost strežbe jedi in pijač_

Ponovno narišimo časovno vrsto, ki jo bomo v nadaljevanju podrobneje analizirali.

```{r fig.dim=c(6,3.7), fig.cap="Časovna vrsta indeksa prihodka za 'Dejavnost strežbe jedi in pijač'."}
plot.ts(ts_strezba, type = "o", pch = 16, cex=0.6, xlab = "leto", ylab = "indeks prihodka", xaxt="s")

# gladilnik
gladilnik2 <- lowess(time(ts_strezba),ts_strezba)
points(gladilnik2$x, gladilnik2$y, type="l", col = "blue")
```


## Transformacija

Kot smo že ugotovili imamo prisotno nekonstantno variabilnost. Da se prepričamo ali je potrebna transformacija (in tudi kakšna), naredimo box-cox test.

```{r results='hide'}
time = 1 + frequency(ts_strezba) * (time(ts_strezba) - start(ts_strezba)[1])

model_str1 = lm(ts_strezba~ time)
model_str2 = lm(ts_strezba~ time + I(time^2))
model_str3 = lm(ts_strezba~ time + I(time^2) + I(time^3))

# izbereva s kvadratnim ker boljsi
anova(model_str1, model_str2, model_str3)
```

```{r eval = F}
plot(time, ts_strezba, typ="o")
points(time, model_str3$fitted.values)
```

```{r fig.cap="Box-Cox za 'Dejavnost strežbe jedi in pijač'."}
boxCox(model_str1)
```

<!--Tom20: ok men tale transformacija izgleda mal cudno...nevem kaj bi pametnega vn potegnu-->

## Analiza avtokoreliranosti 

```{r results=FALSE, fig.cap="Avtokorelogram in parcialni avtokorelogram za 'Dejavnost strežbe jedi in pijač'."}
acf2(ts_strezba, main = "")
```





