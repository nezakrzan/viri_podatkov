---
title: "Seminarska naloga"
author: "Neža Kržan, Tom Rupnik"
output:
  pdf_document:
    number_sections: true
    fig_caption: true
header-includes:
- \usepackage[slovene]{babel}
- \usepackage{float}
- \usepackage[T1]{fontenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.pos = "H", out.extra = "", fig.height = 4, fig.width = 5, fig.align = 'center', warning = F)

# install.packages("readxl")

library(readxl)
library(astsa)
library(car)
library(splines)
```

\tableofcontents
\listoffigures
\listoftables
\newpage

```{r}
# imena posameznih sheet-ov
# excel_sheets("Podatki za seminarske naloge.xlsx")

# Prosta in zasedena delovna mest
data1 = read_excel("Podatki za seminarske naloge.xlsx",
                   sheet = "Prosta in zasedena delovna mest")
# Indeks prihodka po dejavnostih
data2 = read_excel("Podatki za seminarske naloge.xlsx",
                   sheet = "Indeks prihodka po dejavnostih")

zasedena_1 = data1[,"Zasedena_1+_I GOSTINSTVO"]
prosta_1 = data1[,"Prosta_1+_I GOSTINSTVO"]

nastanitvene_dejavnosti = data2[,"Gostinske nastanitvene dejavnosti"]
strezba_jedi_pjac = data2[, "Dejavnost strežbe jedi in pijač"]
```

# Uvod

Za analizo sva si izbrala podatke, ki spadajo pod temo _Gostinstvo_. 

Za indeks prihodka po dejavnosti sva si izbrala _Gostinske nastanitvene dejavnosti_ in _Dejavnost strežbe jedi in pijač_. Podatki so podani za časovno obdobje od januarja 2010 do januarja 2024(`2010M01` do `2024M01`). Frekvenca vzorčenja je približno enakomerna in enaka 12, torej gre za mesečno vzročenje. 

Nato sva analiziral še časovni vrsti za prosta in zasedena delovna mesta v gostinstvu, kjer je zaposlena vsaj 1 oseba. Podatki so podani za časovno obdobje od leta 2008 do leta 2023(`2008Q1` do `2023Q4`) po kvartalih. Frekvenca vzorčenja je približno enakomerna in enaka 4, torej gre za četrtletno vzročenje.

Ker sta frekvenci vzorčenja enakomerni imamo opravka z ekvidistantnimi časovnimi vrstami.

# Predstavitev časovnih vrst

```{r}
# casovni interval 2010M1-2024M1
ts_nastanitve = ts(nastanitvene_dejavnosti, start = c(2010,1), frequency = 12)
ts_strezba = ts(strezba_jedi_pjac, start = c(2010,1), frequency = 12)

# preveriva ce je zadnje obdobje res 2024M1
# end(ts_nastanitve)
# end(ts_strezba)

# casovni interval 2028Q1-2023Q4
ts_zasedena = ts(zasedena_1, start = c(2008, 1), frequency = 4)
ts_prosta = ts(prosta_1, start = c(2008, 1), frequency = 4)

# preveriva ce je zadnje obdobje res 2023Q4
# end(ts_zasedena)
# end(ts_prosta)
```

## Časovna vrsta _Gostinske nastanitvene dejavnosti_

```{r fig.dim=c(6,3.7), fig.cap="Časovna vrsta indeksa prihodka za 'Gostinske nastanitvene dejavnosti'."}
plot.ts(ts_nastanitve, type = "o", pch = 16, cex=0.6, xlab = "leto", ylab = "indeks prihodka", xaxt="s")

# gladilnik
gladilnik <- lowess(time(ts_nastanitve),ts_nastanitve)
points(gladilnik$x, gladilnik$y, type="l", col = "blue")
```

V časovni vrsti je prisotnostnih več različnih komponent časovnega procesa. Sprva opazimo trend, ki je najprej nekoliko padajoč, nato pa se proti koncu leta 2014 obrne in postane pozitiven. Dobro je vidna tudi prisotnost sezonskosti. Indeks se v vsakem letu poveča v začetku leta (januarja), nato nekoliko pade in ponovno raste do poletja (avgusta). Potem sledi padanje do konca let, ko je ponovno nekolikšno povišanje decembra. Tako gibanje je bilo tudi pričakovano, saj je to obdobje poletne in zimske sezone. 

Med letoma 2020 in 2022 je opazno neobičajno gibanje vrednosti. Gre namreč za obdobje pandemije Covid-19, ko so veljali izredni ukrepi, ki so vplivali na gostinske nastanitvene dejavnosti. Opazno je vidno tudi povišanje po letu 2022 oz. sprememba v amplitudnem nihanju. Tudi to je verjetno posledica pandemija ovid-19, saj smo se po dolgem času lahko kam odpravili, država pa je pomagala z izdajo t.i. bonov.

## Časovna vrsta _Dejavnost strežbe jedi in pijač_

```{r fig.dim=c(6,3.7), fig.cap="Časovna vrsta indeksa prihodka za 'Dejavnost strežbe jedi in pijač'."}
plot.ts(ts_strezba, type = "o", pch = 16, cex=0.6, xlab = "leto", ylab = "indeks prihodka",  xaxt="s")

# gladilnik
gladilnik <- lowess(time(ts_strezba),ts_strezba)
points(gladilnik$x, gladilnik$y, type="l", col = "blue")
```

Ponovno opazimo prisotnost trenda, ki je čez celotno obdobje naraščajoče, naklon pa je bil največji med letoma 2015 in 2018. Sprva bi glede na vzorec spreminjanja (nihanja) indeksa lahko rekli, da je prisotna sezonskost. Če natančneje pogledamo sta v posameznem letu ekstremni vrednosti poleti in meseca decembra. Do leta 2018 je bila najvišja vrednost indeksa v posameznem letu dosežena decembra, nato pa je bila višja vrednost dosežena poleti. Iz tega bi lahko rekli, da je nekoliko prisotno ciklično nihanje, vendar ni enako čez celotno opazovano obdobje. 

Prav tako je dobro vidno ekstremno gibanje v času pandemije Covid-19, saj se je takrat zgodil velik padec vrednosti indeksa. Tudi aplituda nihanja se je drastično spremenila v primerjavi s predhodnjim opazovanim obdobjem, za kar je verjetno ponovno krivo obnašanje in potrebe ljudi po pandemiji in izdaja državnih bonov.

## Časovna vrsta _Gostinstvo zasedena delovna mesta 1+_

```{r fig.dim=c(6,3.7), fig.cap="Časovna vrsta za zasedena delovna mesta v gostinstvu, kjer je zaposlena vsaj 1 oseba."}
plot.ts(ts_zasedena, type = "o", pch = 16, cex=0.6, xlab = "leto", ylab = "stevilo delovnih mest",  xaxt="n")
axis(1, at=c(2008, 2011, 2014, 2017, 2020, 2023), labels=c("2008", "2011", "2014", "2017", "2020", "2023"))

# gladilnik
gladilnik <- lowess(time(ts_zasedena),ts_zasedena)
points(gladilnik$x, gladilnik$y, type="l", col = "blue")
```

Iz grafa časovne vrste je možno opaziti le priostnost trenda. Ta je sprva strmo pada do leta 2014 nato pa spremeni predznak in začne strmo naraščati. Sezonskosti ni mogoče zaznati, saj so lokalni ekstremi bolj naključni kot, da bi se ponavljali v ciklu. 

Vidna sta, da dva 'ekstremna obdobja'. Hud padec okoli leta 2012, ki je vztrajal do leta 2015, ko si celotno gospodarstvo še vedno ni dobro opomoglo od začetka krize leta 2008 ter okoli leta 2020, ko je bil čas pandemije Covid-19.

## Časovna vrsta _Gostinstvo prosta delovna mesta 1+_

```{r echo=FALSE, fig.cap="Časovna vrsta za prosta delovna mesta v gostinstvu, kjer je zaposlena vsaj 1 oseba.", fig.dim=c(6,3.7)}
plot.ts(ts_prosta, type = "o", pch = 16, cex=0.6, xlab = "leto", ylab = "stevilo delovnih mest",  xaxt="n")
axis(1, at=c(2008, 2011, 2014, 2017, 2020, 2023), labels=c("2008", "2011", "2014", "2017", "2020", "2023"))

# gladilnik
gladilnik <- lowess(time(ts_prosta),ts_prosta)
points(gladilnik$x, gladilnik$y, type="l", col = "blue")
```

Iz grafa časovne vrste je možno opaziti le priostnost trenda. Ta čez celotno opazovano obdobje narašča. Sprva nekoliko bolj položno, po letu 2013 pa se naklon poveča. Sezonskosti ni mogoče zaznati, saj so lokalni ekstremi bolj naključni kot da bi se ponavljali v ciklu. Ponovno pa je vidno ekstrmeno obdobje (čas pandemije Covid-19).

# _Gostinske nastanitvene dejavnosti_

Ponovno narišimo časovno vrsto, ki jo bomo v nadaljevanju podrobneje analizirali.

```{r fig.dim=c(6,3.7), fig.cap="Časovna vrsta indeksa prihodka za 'Gostinske nastanitvene dejavnosti'."}
plot.ts(ts_nastanitve, type = "o", pch = 16, cex=0.6, xlab = "leto", ylab = "indeks prihodka", xaxt="n")
axis(1, at=c(2008, 2011, 2014, 2017, 2020, 2023), labels=c("2008", "2011", "2014", "2017", "2020", "2023"))

# gladilnik
gladilnik <- lowess(time(ts_nastanitve),ts_nastanitve)
points(gladilnik$x, gladilnik$y, type="l", col = "blue")
```

## Transformacija

<!-- Tom21: zdej sm naredu se model s cleni sin()/cos() pa se ta najbolj prilega ampak je box-cox potem bolj cuden-->

Kot smo že ugotovili imamo prisotno nekonstantno variabilnost. Da se prepričamo ali je potrebna transformacija (in tudi kakšna), naredimo box-cox test.

```{r results='hide'}
time = 1 + frequency(ts_nastanitve) * (time(ts_nastanitve) - start(ts_nastanitve)[1])

model_nast1 = lm(ts_nastanitve~ time)
model_nast2 = lm(ts_nastanitve~ time + I(time^2))
model_nast3 = lm(ts_nastanitve~ time + I(time^2)+
                 I(sin(2 * pi/12 * time)) + I(cos(2 * pi/12 * time))+ 
                 I(sin(2 * pi/6 * time)) + I(cos(2 * pi/6 * time)))

# izbereva s kvadratnim ker boljsi
anova(model_nast1, model_nast2, model_nast3)

# plot(time, ts_nastanitve, type = "o");
# points(time, model_nast3$fitted.values, type="l", col = "red")
```

```{r fig.cap="Box-Cox za 'Gostinske nastanitvene dejavnosti'."}
boxCox(model_nast2)
```

Ker je $\lambda = 1$ znotraj intervala zaupanja, to pomeni da transformacija ni potrebna.

## Analiza avtokoreliranosti 

```{r results=FALSE, fig.cap="Avtokorelogram in parcialni avtokorelogram za 'Gostinske nastanitvene dejavnosti'."}
acf2(ts_nastanitve, main = "")
```

Zgornji ACF graf je precej pričakovan, saj sta v časovni vrsti prisotna tako rahel trend kot tudi sezonskost. Trend se izraža s počasnim padanjem vrednosti avtokorelacijskih koeficientov z odlogi. Sezona pa je vidna z nihanjem vrednosti koeficientov oz. periodničnostjo in izrazitimi vrhovi, ki se ponavljajo.

<!--Tom18: za PACF se ne spomnem zdej nic pametnega
Neza21: ker tud nc pametnega ne pokaze hahahah-->

S postopnim diferenciranjem bomo najprej odpravili trend nato pa še sezonskost.

```{r fig.dim=c(6,5)}
par(mfrow=c(2,2), oma=c(1,1,0,0))
plot(ts_nastanitve, main="Originalna", xlab="", ylab="")
plot(diff(ts_nastanitve, lag=1), main="Lag=1", xlab="", ylab="")
plot(diff(ts_nastanitve, lag=12), main="Lag=12", xlab="", ylab="")
plot(diff(diff(ts_nastanitve, lag=1),lag=12), main="Lag=1 in Lag=12", xlab="", ylab="")

mtext("leto",side=1,line=0,outer=TRUE,cex=1)
mtext("indeks prihodka",side=2,line=0,outer=TRUE,cex=1,las=0)
```

Na desnem spodnjem grafu (odstranjen trend in sezonskost) vidimo, da je pričakovana vrednost konstantna (enak 0) in variabilnost je končna (se s časom ne povečuje ali zmanjšuje). Torej lahko zaključimo, da imamo stacionarno časovno vrsto.

## Izbira ustreznega modela

Sprva časovno vrsto diferenciramo tako, da odstranimo linearni trend in sezonskost. Za nadaljno izbiro ustreznega modela si izrišimo avtokorelogram in parcialni avtokorelogram.

```{r}
# shraniva si diferencirano casovno vrsto
ts_stac1 = arima(ts_nastanitve, order = c(0, 1, 0),
                 seasonal = list(order = c(0, 1, 0),
                                 period = frequency(ts_nastanitve)),
                 method = "CSS-ML" )
```

```{r results=FALSE, fig.cap="Avtokorelogram in parcialni avtokorelogram za stacionarno 'Gostinske nastanitvene dejavnosti'."}
acf2(ts_stac1$residuals, main = "")
```

<!-- Tom25: sm zdej tole mal popravu ker je blo p=12 in q=12 res mal veliko

Iz avtokorelograma in parcialnega avtokorelograma vidimo, da je nekaj koeficientov statistično zančilnih (izven 95% intervala). Na podlagi njiju težko ocenimo, za kateri ARMA(p, q) proces gre. Kot največji možni vrednosti za $p$ in $q$ izberemo pmax=12 in qmax=12. 

```{r eval=F, message=FALSE, warning=FALSE, results='hide'}
# dolocimo maksimalno vrednost p in q 

best.order <- c(0, 0, 0)
best.aic <- Inf
pmax <- 12
qmax <- 12
for (i in 0:pmax) {
  for (j in 0:qmax) {
    fit.aic <- AIC(arima(ts_stac1, order = c(i, 0, j)))
    if (fit.aic < best.aic){
      best.order <- c(i, 0, j)
      best.arma <- arima(ts_stac1, order = best.order)
      best.aic <- fit.aic
    }
  }
}
best.order
best.arma
```

Algoritem nam kot model z najnižjo AIC vrednostjo vrne model ARMA(0,12). <!-- Neza21: misls da ni to velik 12?, a ni zadnic rekla, da je ponavad okol 4, 5. pa tud koeficienti so vsi po 0.3, kar je kr precej majno ne ze tko na splosno ce ignorirava 95% iz, vem da algoritem tko vrze, sam tko morda v razmislek... tud za naprej da se ne bo model prevec prilegu-->





```{r message=FALSE, results="hide"}
# mod.sarima_nast <- arima(ts_nastanitve, order = c(3, 1, 3),
#                      seasonal = list(order = c(2, 1, 2),
#                                      period = frequency(ts_nastanitve)))
# AIC: 1218

mod.sarima_nast <- arima(ts_nastanitve, order = c(4, 1, 4),
                     seasonal = list(order = c(2, 1, 2),
                                     period = frequency(ts_nastanitve)))
# AIC: 1216
# ker je AIC manjsi izbereva tega
# sm probal se p=8 in q=8 pa pride vecji AIC...

Box.test(mod.sarima_nast$resid, lag = 48, type = c("Ljung-Box"),
         fitdf = mod.sarima_nast$arma[1] + mod.sarima_nast$arma[2] +
           mod.sarima_nast$arma[3] + mod.sarima_nast$arma[4])

# p-vrednost: 0.377 kar je ok

# ocene <- sarima(ts_nastanitve, p = 4, d = 1, q = 4, P=2, D=1, Q=2, S=12,
#                 details = TRUE)
# 
# ocene$ttable
# vecino clenov je stat. zancilnih
```

<!-- Tom25: to sm tud zakomentiral ker se nanasa na zgonje zakomentirano

```{r eval=F, results=FALSE, fig.cap="Avtokorelogram in parcialni avtokorelogram 'Gostinske nastanitvene dejavnosti' model ARMA(0,12)."}
# to je ker je zgonji chunk eval=F
best.arma = arima(ts_stac1, order = c(0,0,12))

acf2(best.arma$resid, main = "")
```

Iz zgornjih dveh grafov vidimo, da smo se z modeliranjem $MA(12)$ res znebili koreliranosti (koeficienti pri vseh odlogih so znotraj 95% intervala zaupanja).
-->

```{r results=FALSE, fig.cap="Avtokorelogram in parcialni avtokorelogram za model sarima((4,1,4),(2,1,2)) 'Gostinske nastanitvene dejavnosti'."}
acf2(mod.sarima_nast$resid, main="")
```

Iz zgornjih dveh grafov vidimo, da smo se z modelom SARIMA$(4,1,4)(2,1,2)_{12}$ res znebili koreliranosti (koeficienti pri vseh odlogih so znotraj 95% intervala zaupanja).

## Napoved

```{r results=F}
sarima.for(ts_nastanitve, n.ahead = 36, p = 4, d = 1, q = 4,
           P = 2, D = 1, Q = 2, S = 12,
           plot.all = TRUE)
```

Na grafu je prikazana napoved za naslednje 3 leta (36 mesecev). Vidimo, da napoved ni preveč dobra, saj je amplituda nihanja dosti velika. Še večje vrednosti pa zavzamejo intervali zaupanja, ki so zelo široki. 

Časovno vrsto razdelimo še na učno (1.2010-12.2021) in testno statistiko (1.2022-1.2024). S tem želimo na znanih podatkih preveriti pravilnost napovedi, ki jih naredimo na podlagi modela in predhodnjih vrednosti.

```{r results=F}
nastanitev.ucna <- window(ts_nastanitve, start = c(2010, 1), end = c(2021, 12))
nastanitev.test <- window(ts_nastanitve, start = c(2022, 1), end = c(2024, 1))

sarima.for(nastanitev.ucna, n.ahead = 24, p = 4, d = 1, q = 4, P = 2, D = 1, Q = 2, S = 12, plot.all = TRUE)
points(nastanitev.test, type = "o")
```

Opazimo, da z napovedjo (rdeča) podcenimo vrednosti časovne vrste (črna). So pa vrednosti časovne vrste vseeno v intervalu zaupanja napovedi.

# _Dejavnost strežbe jedi in pijač_

Ponovno narišimo časovno vrsto, ki jo bomo v nadaljevanju podrobneje analizirali.

```{r fig.dim=c(6,3.7), fig.cap="Časovna vrsta indeksa prihodka za 'Dejavnost strežbe jedi in pijač'."}
plot.ts(ts_strezba, type = "o", pch = 16, cex=0.6, xlab = "leto", ylab = "indeks prihodka", xaxt="n")
axis(1, at=c(2008, 2011, 2014, 2017, 2020, 2023), labels=c("2008", "2011", "2014", "2017", "2020", "2023"))

# gladilnik
gladilnik2 <- lowess(time(ts_strezba),ts_strezba)
points(gladilnik2$x, gladilnik2$y, type="l", col = "blue")
```


## Transformacija

Kot smo že ugotovili imamo prisotno nekonstantno variabilnost. Da se prepričamo ali je potrebna transformacija (in tudi kakšna), naredimo box-cox test.

```{r results='hide'}
time = 1 + frequency(ts_strezba) * (time(ts_strezba) - start(ts_strezba)[1])

model_str1 = lm(ts_strezba~ time)
model_str2 = lm(ts_strezba~ time + I(time^2))
model_str3 = lm(ts_strezba~ time + I(time^2) + I(time^3))

# izbereva s kvadratnim ker boljsi
anova(model_str1, model_str2, model_str3)

# plot(time, ts_strezba, type = "o");
# points(time, model_str3$fitted.values, type="l", col = "red")
```

```{r eval = F}
plot(time, ts_strezba, typ="o")
points(time, model_str3$fitted.values)
```

```{r fig.cap="Box-Cox za 'Dejavnost strežbe jedi in pijač'."}
boxCox(model_str1)
```

<!--Tom20: ok men tale transformacija izgleda mal cudno...nevem kaj bi pametnega vn potegnu-->

## Analiza avtokoreliranosti 

```{r results=FALSE, fig.cap="Avtokorelogram in parcialni avtokorelogram za 'Dejavnost strežbe jedi in pijač'."}
acf2(ts_strezba, main = "")
```

<!-- Tom21: hmm a bi tukej ti dala za ACF da je prisotna sezonskost...ker na grafu osnovne casovne vrste ni glih izgledalo pa se spremeni se vrh iz decembra na poletje...ampak tukej pa izgleda kot da bi bila prisotna sezonskost...
Neza21: pomojem da ni, ker koef. ful hitr padejo, sicer je periodicno sam a ni tko da morjo in za trend in za sozono ce je koef ful pocas padat da lahko recemo da je prisotna?-->

Sprva nas graf ACF nekoliko spominja na vsebovanost seznoske komponente vendar vrednosti dokaj hitro padajo in je pri kasnejših (sezonskih) odlogih postane zanemarljiva. Ali bomo pri modeliranju upoštevali tudi seznoskost se bomo odločili v naslednjem razdelku, kjer bomo časovno vrsto ustrezno diferencirali in primerjali ACF ter PACF. Zagotovo pa imamo prisotnost trenda, saj vrednosti postopamo padajo proti 0.

```{r fig.dim=c(6,5)}
par(mfrow=c(2,2), oma=c(1,1,0,0))
plot(ts_strezba, main="Originalna", xlab="", ylab="")
plot(diff(ts_strezba, lag=1), main="Lag=1", xlab="", ylab="")
plot(diff(ts_strezba, lag=12), main="Lag=12", xlab="", ylab="")
plot(diff(diff(ts_strezba, lag=1),lag=12), main="Lag=1 in Lag=12", xlab="", ylab="")

mtext("leto",side=1,line=0,outer=TRUE,cex=1)
mtext("indeks prihodka",side=2,line=0,outer=TRUE,cex=1,las=0)
```

Iz zgornjih grafov bi lahko rekli, da časovna vrsta pri kateri diferenciramo trend in seznoskost, izgleda nekoliko boljše. Ta je nekoliko bolj gladka in tudi amplituda nihanja je manjša, z izjemo ekstremnih let.

<!-- Tom21: tudi tukej ce diferencirava z 12 torej sezonskost men izgleda bolse tko da mogoce je res prisotna se sezonskost...ampak potem bo treba popravit se besedilo v prvem poglavju
Neza21: ne rabis popravlat, tm se nama je tko zdel, zdej po podrobni analizi pa ugotoviva drugac, sej toj cist normalno, pa zih ji bo vsec-->

## Izbira ustreznega modela

Sprva diferenciramo le linearni trend.

```{r}
# shraniva si diferencirano casovno vrsto
ts_stac2_1 = arima(ts_strezba, order = c(0, 1, 0),
                 seasonal = list(order = c(0, 0, 0),
                                 period = frequency(ts_nastanitve)),
                 method = "CSS-ML" )
```

```{r results=FALSE, fig.cap="Avtokorelogram in parcialni avtokorelogram za stacionarno 'Dejavnost strežbe jedi in pijač'."}
acf2(ts_stac2_1$residuals, main = "")
```

Na grafu ACF so statistično značilni koef. avtokorelacije pri vseh (sezonskih) odlogih. To nakazuje, da je mogoče res potrebno diferencirati tudi seznosko komponento. 

```{r}
# shraniva si diferencirano casovno vrsto
ts_stac2_2 = arima(ts_strezba, order = c(0, 1, 0),
                 seasonal = list(order = c(0, 1, 0),
                                 period = frequency(ts_nastanitve)),
                 method = "CSS-ML" )
```

```{r results=FALSE, fig.cap="Avtokorelogram in parcialni avtokorelogram za stacionarno 'Dejavnost strežbe jedi in pijač'."}
acf2(ts_stac2_2$residuals, main = "")
```

Grafa sedaj res izgledata bolje. Z izjemo nekaj odlogov na začetku je večino vrednosti znotraj 95% intervala. Prav tako smo se znebili statistično značilnih vrednosti, ki so očitno nakazovale na prsotnost sezonskosti.


```{r message=FALSE, results="hide"}
mod.sarima_str <- arima(ts_strezba, order = c(5, 1, 5),
                     seasonal = list(order = c(2, 1, 1),
                                     period = frequency(ts_strezba)))
# AIC: 1207.3

mod.sarima_str2 <- arima(ts_strezba, order = c(5, 1, 8),
                     seasonal = list(order = c(2, 1, 1),
                                     period = frequency(ts_strezba)))
# AIC: 1203.5

mod.sarima_str3 <- arima(ts_strezba, order = c(5, 1, 8),
                     seasonal = list(order = c(2, 1, 2),
                                     period = frequency(ts_strezba)))
# nic se ne izboljsa v primerjavi s prejsnim

mod.sarima_str4 <- arima(ts_strezba, order = c(5, 1, 8),
                     seasonal = list(order = c(3, 1, 1),
                                     period = frequency(ts_strezba)))
# AIC: 1205

# ker imata 2 in 3 najmanjšo AIC vrednost probamo to

# Box.test(mod.sarima_str2$resid, lag = 48, type = c("Ljung-Box"),
#          fitdf = mod.sarima_str2$arma[1] + mod.sarima_str2$arma[2] +
#            mod.sarima_str2$arma[3] + mod.sarima_str2$arma[4])

# p-vrednost: 0.52 kar je ok

# ocene <- sarima(ts_strezba, p = 5, d = 1, q = 8, P=2, D=1, Q=1, S=12,
#                 details = TRUE)
# 
# ocene$ttable
# # kaj je s tem p-vrednostmi haha

# Box.test(mod.sarima_str3$resid, lag = 48, type = c("Ljung-Box"),
#          fitdf = mod.sarima_str3$arma[1] + mod.sarima_str3$arma[2] +
#            mod.sarima_str3$arma[3] + mod.sarima_str3$arma[4])

# p-vrednost: 0.48 kar je ok

# ocene <- sarima(ts_strezba, p = 5, d = 1, q = 8, P=2, D=1, Q=2, S=12,
#                 details = TRUE)
# 
# ocene$ttable
# # p-vrednosti izgledajo boljse...

# za nadaljevanje bom vzel mod.sarima_str3
```

## Napoved

```{r results=F}
sarima.for(ts_strezba, n.ahead = 36, p = 5, d = 1, q = 8,
           P = 2, D = 1, Q = 2, S = 12,
           plot.all = TRUE)
```

Na grafu je prikazana napoved za naslednje 3 leta (36 mesecev). Vidimo, da napoved ni preveč dobra, saj napovedi ne sledijo naraščajočemu trendu. Tudi intervali zaupanja so zelo široki in zato je napoved zelo neinformativna.

Časovno vrsto razdelimo še na učno (1.2010-12.2021) in testno statistiko (1.2022-1.2024). S tem želimo na znanih podatkih preveriti pravilnost napovedi, ki jih naredimo na podlagi modela in predhodnjih vrednosti.

```{r results=F}
strezba.ucna <- window(ts_strezba, start = c(2010, 1), end = c(2021, 12))
strezba.test <- window(ts_strezba, start = c(2022, 1), end = c(2024, 1))

sarima.for(strezba.ucna, n.ahead = 24, p = 4, d = 1, q = 4, P = 2, D = 1, Q = 2, S = 12, plot.all = TRUE)
points(strezba.test, type = "o")
```

Opazimo, da z napovedjo (rdeča) podcenimo vrednosti časovne vrste (črna). So pa vrednosti časovne vrste vseeno v intervalu zaupanja napovedi.

# Gostinstvo zasedena delovna mesta 1+

Ponovno narišimo časovno vrsto, ki jo bomo v nadaljevanju podrobneje analizirali.

```{r fig.dim=c(6,3.7), fig.cap="Časovna vrsta 'Gostinstvo zasedena delovna mesta 1+'."}
plot.ts(ts_zasedena, type = "o", pch = 16, cex=0.6, xlab = "leto", ylab = "stevilo delovnih mest", xaxt="n")
axis(1, at=c(2008, 2011, 2014, 2017, 2020, 2023), labels=c("2008", "2011", "2014", "2017", "2020", "2023"))

# gladilnik
gladilnik3 <- lowess(time(ts_zasedena),ts_zasedena)
points(gladilnik3$x, gladilnik3$y, type="l", col = "blue")
```

## Transformacija

Da preverimo ali je potrebna transformacija (in tudi kakšna), naredimo box-cox test.

```{r results='hide'}
time = 1 + frequency(ts_zasedena) * (time(ts_zasedena) - start(ts_zasedena)[1])

model_zasedena1 = lm(ts_zasedena~ time)
model_zasedena2 = lm(ts_zasedena~ time + I(time^2))
model_zasedena3 = lm(ts_zasedena~ time + I(time^2) + I(time^3))
model_zasedena4 = lm(ts_zasedena~ ns(time, df = 6))

anova(model_zasedena1, model_zasedena2, model_zasedena3, model_zasedena4)

# plot(time, ts_zasedena, type = "o", cex=0.5)
# points(time, model_zasedena4$fitted.values, type="l", col = "red")
```

```{r fig.cap="Box-Cox za 'Gostinstvo zasedena delovna mesta 1+'."}
boxCox(model_zasedena4)
```

<!-- Tom21: tukej kaze na transformacijo log() ampak jst k si narisem mi ne izgleda neki velika razlika, razn da se skala na y osi spremeni...ja pa res da je znotrej 95% intervala tudi 1 kar pomeni ni potrebna transformacija
Neza21: sm resla problem-->

Na zgornjem graf vidimo, da bi bila priporočljiva logaritemska transformacija, ampak ker imamo v 95\% intervalu zaupanja tudi $\lambda=1$ se zaenkrat ne odločiva za logritemsko transformacijo.

## Analiza avtokoreliranosti 

```{r results=FALSE, fig.cap="Avtokorelogram in parcialni avtokorelogram za 'Gostinstvo zasedena delovna mesta 1+'."}
acf2(ts_zasedena, main = "")
# Neza21: ce povecava lage gre mogoc v periodicnost?
acf(ts_zasedena, lag=500)
```


Iz zgornjega ACF grafa se dobro vidi prisotnost trenda, saj vrednosti koeficientov počasi padajo proti 0. Kot smo že iz osnovnega prikaza časovne vrste lahko opazili, ni izrazite sezonskosti, kar se vidi tudi na avtokorelogramu, saj ni ponavljajočih se vrhov (ekstremnih vrednosti).

Z diferenciranjem trenda bomo poskusili dobiti stacionarno časovno vrsto.

```{r fig.dim=c(7,3.5)}
par(mfrow=c(1,2))
plot(ts_zasedena, main="Originalna", xlab="leto", ylab="stevilo delovnih mest")
plot(diff(ts_zasedena, lag=1), main="Lag=1", xlab="leto", ylab="stevilo delovnih mest")
```

Z diferenciranjem trenda smo res dobili stacionarno časovno vrsto. Pričakovana vrednost je enaka 0, variabilnost pa je končna. 

## Izbira ustreznega modela

```{r}
# shraniva si diferencirano casovno vrsto
ts_stac3 = arima(ts_zasedena, order = c(0, 1, 0),
                 seasonal = list(order = c(0, 0, 0),
                                 period = frequency(ts_nastanitve)),
                 method = "CSS-ML" )
```

```{r results=FALSE, fig.cap="Avtokorelogram in parcialni avtokorelogram za stacionarno 'Gostinstvo zasedena delovna mesta 1+'."}
acf2(ts_stac3$residuals, main = "")
```

<!--
Neza21: men se zdi dase zdej kle ful vid periodicnost, kaj ti misls? na acf...
Tom22: bi pomagalo ce bi jst spremenil kodo, ce ze kopiram od drugje haha zdej je mal drugacna situacija
-->

Grafa prikazujeta idelani izid. Koeficienti pri vseh odlogih so znotraj 95% intervala, torej v modelu ni statistično značilne korelacije med členi. Iz tega lahko zaključimo, da časovna vrsta predstavlja beli šum.

## Napoved

```{r results=F}
sarima.for(ts_zasedena, n.ahead = 12, p = 0, d = 1, q = 0, plot.all = TRUE)
```

Na grafu je prikazana napoved za naslednje 3 leta (12 kvartilov). Kot smo zaključili v prejšnjem razdelku časovna vrsta predstavlja beli šum, torej napoved ne bo preveč informativna. Temu primerni so tudi intervali zaupanja, ki so precej široki. Vidimo le, da napoved sledi narašačjočemu trendu

Časovno vrsto razdelimo še na učno (2010Q1-2021Q4) in testno statistiko (2022Q1-2023Q4). S tem želimo na znanih podatkih preveriti pravilnost napovedi, ki jih naredimo na podlagi modela in predhodnjih vrednosti.

```{r results=F}
zasedena.ucna <- window(ts_zasedena, start = c(2010, 1), end = c(2021, 4))
zasedena.test <- window(ts_zasedena, start = c(2022, 1), end = c(2023, 4))

sarima.for(zasedena.ucna, n.ahead = 8, p = 0, d = 1, q = 0, plot.all = TRUE)
points(zasedena.test, type = "o")
```

# Gostinstvo prosta delovna mesta 1+

Ponovno narišimo časovno vrsto, ki jo bomo v nadaljevanju podrobneje analizirali.

```{r echo=FALSE, fig.cap="Časovna vrsta 'Gostinstvo prosta delovna mesta 1+'.", fig.dim=c(6,3.7)}
plot.ts(ts_prosta, type = "o", pch = 16, cex=0.6, xlab = "leto", ylab = "stevilo delovnih mest",  xaxt="n")
axis(1, at=c(2008, 2011, 2014, 2017, 2020, 2023), labels=c("2008", "2011", "2014", "2017", "2020", "2023"))

# gladilnik
gladilnik <- lowess(time(ts_prosta),ts_prosta)
points(gladilnik$x, gladilnik$y, type="l", col = "blue")
```

## Transformacija

Da preverimo ali je potrebna transformacija (in tudi kakšna), naredimo box-cox test.

```{r results='hide'}
time = 1 + frequency(ts_prosta) * (time(ts_prosta) - start(ts_prosta)[1])

model_prosta1 = lm(ts_prosta~ time)
model_prosta2 = lm(ts_prosta~ time + I(time^2))
model_prosta3 = lm(ts_prosta~ time + I(time^2) + I(time^3))
model_prosta4 = lm(ts_prosta~ ns(time, df = 8))

anova(model_prosta1, model_prosta2, model_prosta3, model_prosta4)

# plot(time, ts_prosta, type = "o", cex=0.5)
# points(time, model_prosta4$fitted.values, type="l", col = "red")
```

```{r fig.cap="Box-Cox za 'Gostinstvo prosta delovna mesta 1+'."}
boxCox(model_prosta4)
```

Na zgornjem graf vidimo, da je $\lambda=0$ znotraj 95% intervala, torej je priporočljiva logaritemska transformacija.

```{r}
ts_prosta_log = log(ts_prosta) 
```


## Analiza avtokoreliranosti 

```{r results=FALSE, fig.cap="Avtokorelogram in parcialni avtokorelogram za 'Gostinstvo prosta delovna mesta 1+'."}
acf2(ts_prosta_log, main = "")
```

Iz zgornjega ACF grafa se dobro vidi prisotnost trenda, saj vrednosti koeficientov počasi padajo proti 0. Vendar pa ni opaziti periodičnega nihanja, kar pomeni da časovna vrsta res ne vsebuje sezonskosti. 

Z diferenciranjem trenda bomo poskusili dobiti stacionarno časovno vrsto.

```{r fig.dim=c(7,3.5)}
par(mfrow=c(1,2))
plot(ts_prosta_log, main="Originalna", xlab="leto", ylab="stevilo delovnih mest")
plot(diff(ts_prosta_log, lag=1), main="Lag=1", xlab="leto", ylab="stevilo delovnih mest")
```

Z diferenciranjem linearnega trenda smo res dobili stacionarno časovno vrsto. Če si ogledamo graf na desni opazimo, da je pričakovana vrednost enak 0, variabilnost pa je končna. S temi pogoji zadostimo stacionarnost.


## Izbira ustreznega modela

```{r}
# shraniva si diferencirano casovno vrsto
ts_stac4 = arima(ts_prosta_log, order = c(0, 1, 0),
                 seasonal = list(order = c(0, 0, 0),
                                 period = frequency(ts_nastanitve)),
                 method = "CSS-ML" )
```

```{r results=FALSE, fig.cap="Avtokorelogram in parcialni avtokorelogram za stacionarno 'Gostinstvo prosta delovna mesta 1+'."}
acf2(ts_stac4$residuals, main = "")
```


Grafa ponovno prikazujeta idelani izid. Koeficienti pri vseh odlogih so znotraj 95% intervala, torej v modelu ni statistično značilne korelacije med členi. Iz tega lahko zaključimo, da časovna vrsta predstavlja beli šum.


## Napoved

```{r results=F}
sarima.for(ts_prosta_log, n.ahead = 12, p = 0, d = 1, q = 0, plot.all = TRUE)
```

Na grafu je prikazana napoved za naslednje 3 leta (12 kvartilov). Kot smo zaključili v prejšnjem razdelku časovna vrsta predstavlja beli šum, torej napoved ne bo preveč informativna. Temu primerni so tudi intervali zaupanja, ki so precej široki. Vidimo le, da napoved sledi narašačjočemu trendu

Časovno vrsto razdelimo še na učno (2010Q1-2021Q4) in testno statistiko (2022Q1-2023Q4). S tem želimo na znanih podatkih preveriti pravilnost napovedi, ki jih naredimo na podlagi modela in predhodnjih vrednosti.

```{r results=F}
prosta.ucna <- window(ts_prosta_log, start = c(2010, 1), end = c(2021, 4))
prosta.test <- window(ts_prosta_log, start = c(2022, 1), end = c(2023, 4))

sarima.for(prosta.ucna, n.ahead = 8, p = 0, d = 1, q = 0, plot.all = TRUE)
points(prosta.test, type = "o")
```