---
title: "Domača naloga 1"
author: "Neža Kržan, Tom Rupnik Medjedovič"
output:
  pdf_document:
    fig_caption: true
    number_sections: true
header-includes:
- \usepackage[slovene]{babel}
- \usepackage{float}
- \usepackage[T1]{fontenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.align = "center", fig.pos = "H", message = FALSE, warning = FALSE, results = F, fig.height = 4, fig.width = 5)

# potrebne knjižnice
library(ggplot2)
library(car)
library(tidyr)
library(ADGofTest)

# seme
set.seed(2024)
```


# Navodilo{-}

Estimate the validity of a test for the difference of arithmetic means from three independent samples. Compare method where you assume:

- equal variance (classic ANOVA)
- unequal variances (Welch's ANOVA)
- an option where you assume equal variances if you cannot reject the assumption of equality of variances (at 5% risk) with some test for equality of variances (e.g. Levene's), and unequal variances if you can.

Generate the data so that the variances are equal in some places and different in others.

<!--
Prevod v SLO:
Oceni veljavnost testa za razliko aritmetičnih sredin iz treh neodvisnih vzorcev. Primerjaj naslednje metode:
- predpostavka enakih varianc (klasični ANOVA),
- predpostavka neenakih varianc (Welchov ANOVA),
- možnost, kjer predpostaviš enake variance, če ne moreš zavrniti predpostavke o enakosti varianc (pri 5 % tveganju) s kakšnim testom za enakost varianc (npr. Levenejev test), in neenake variance, če lahko.

Generiraj podatke tako, da bodo variance na nekaterih mestih enake, na drugih pa različne.

Ker mamo validity of a test mormo:
If you are assessing the validity of a test, use (at least) two measures, one relating to the distribution of the p-value or test statistic and one testing the size of the test at the chosen level of risk.
-->

# Generiranje podatkov

```{r generiranje podatkov, fig.cap="Primer gostote porazdelitev vzorcev za različne kombinacije varianc.", return_all = TRUE}
generate_data <- function(n, means, vars) {
  sample1 <- rnorm(n, mean = means, sd = sqrt(vars[1]))
  sample2 <- rnorm(n, mean = means, sd = sqrt(vars[2]))
  sample3 <- rnorm(n, mean = means, sd = sqrt(vars[3]))
  data = data.frame(sample1 = sample1, sample2 = sample2, sample3 = sample3)
  return(data)
}

n = 1000
means = 0
# vars = c("1,1,1", "1,10,1", "1,5,10")

vars = c(1,10,1)
data = generate_data(n, means, vars)
data.long = data.frame(vrednosti = c(data$sample1, data$sample2, data$sample3),
                       vzorec = c(rep("vzorec 1", n), rep("vzorec 2", n), rep("vzorec 3", n)))
g1 = ggplot(data.long, aes(x = vrednosti, color = vzorec)) +
  geom_density(size = 0.5) + 
  labs(title = "var = (1,10,1)",
       x = " ",
       y = "density",
       color = " ") +
  guides(color = guide_legend(nrow = 1, override.aes = list(linetype = 1, shape = 15))) + 
  theme_minimal() 

library(cowplot)
legend <- get_legend(g1)
g1 = g1 + theme(legend.position = "none")

vars = c(1,5,10)
data = generate_data(n, means, vars)
data.long = data.frame(vrednosti = c(data$sample1, data$sample2, data$sample3),
                       vzorec = c(rep("vzorec 1", n), rep("vzorec 2", n), rep("vzorec 3", n)))
g2 = ggplot(data.long, aes(x = vrednosti, color = vzorec)) +
  geom_density(size = 0.5) + 
  labs(title = "var = (1,5,10)",
       x = " ",
       y = " ",
       color = " ") +
  guides(color = guide_legend(override.aes = list(linetype = 1, shape = 15))) + 
  theme_minimal() + 
  theme(legend.position = "none")

vars = c(1,1,1)
data = generate_data(n, means, vars)
data.long = data.frame(vrednosti = c(data$sample1, data$sample2, data$sample3),
                       vzorec = c(rep("vzorec 1", n), rep("vzorec 2", n), rep("vzorec 3", n)))
g3 = ggplot(data.long, aes(x = vrednosti, color = vzorec)) +
  geom_density(size = 0.5) + 
  labs(title = "var = (1,1,1)",
       x = " ",
       y = " ",
       color = " ") +
  guides(color = guide_legend(override.aes = list(linetype = 1, shape = 15))) + 
  theme_minimal()+ 
  theme(legend.position = "none")

library(gridExtra)
combined_plots <- plot_grid(g1, g2, g3, nrow = 1)
plot_grid(combined_plots, legend, ncol = 1, rel_heights = c(1, 0.3))

# ne vem al je bols da je box plot?
# ggplot(data.long, aes(x = vzorec, y = vrednosti, color = vzorec)) +
#  geom_boxplot(size = 0.5) + 
#  labs(title = " ",
#       x = " ",
#       y = "density",
#       color = " ") +
#  guides(color = guide_legend(override.aes = list(linetype = 1, shape = 15))) + 
#  theme_minimal()
```


# Simulacije (p-vrednost)

<!-- 
Tom: 
Ker preverjava ustreznost testa je v vseh skupinah enako povprecje 0
jst bi porazdelitev pustil kr skoz normalno,
spreminjava samo variance recimo:
- vse enake (1,1,1)
- ena razlicna (1, 10, 1)
- vse razlicne (1, 5, 10)

pa potem se da mal spreminjava velikost skupin:
- vse enake ([15, 15, 15], [40, 40, 40], [100, 100, 100], [1000, 1000, 1000])
-->


```{r simulacije p-vrednost}
st_ponovitev = 1000
velikost = c(15, 40, 100, 1000)

settings = expand.grid(i=1:st_ponovitev, n = velikost,
                       var = c("1,10,1", "1,5,10", "1,1,1"))

if(file.exists("p_vrednost.RDS")){
  res<-readRDS("p_vrednost.RDS")
} else {
  res<-cbind(settings, pANOVA=NA, pANOVA_2=NA, pMETHOD3=NA)
  for(row in 1:nrow(settings)){
    velikost = settings$n[row]
    var_skupaj = as.numeric(strsplit(as.character(settings$var[row]),",")[[1]])
    sd1 = sqrt(var_skupaj[1])
    sd2 = sqrt(var_skupaj[2])
    sd3 = sqrt(var_skupaj[3])
    
    x<-c(rnorm(velikost, 0, sd1),
         rnorm(velikost, 0, sd2),
         rnorm(velikost, 0, sd3))
    gr<-factor(rep(1:3, times=c(velikost,velikost,velikost)))
    
    res$pANOVA[row] = summary(aov(x~gr))[[1]][["Pr(>F)"]][1]
    res$pANOVA_2[row] = oneway.test(x~gr, var.equal = FALSE)$p.value
    
    p_test_enak_V = leveneTest(x~gr)$`Pr(>F)`[1]
    if(p_test_enak_V > 0.05){
      res$pMETHOD3[row] = summary(aov(x~gr))[[1]][["Pr(>F)"]][1]
    } else {
      res$pMETHOD3[row] = oneway.test(x~gr, var.equal = FALSE)$p.value
    }
  }
  saveRDS(object = res, file="p_vrednost.RDS")
}

```


```{r risanje p-vrednost}
# dava v format long
resLong = pivot_longer(res, cols=matches("^p[AM]"), values_to = "pVal",
                       names_to = "method", names_prefix = "p")

# testirava za enakomerno porazdelitev z Anderson-Darling testom
valAnal = aggregate(pVal~ n + var + method , data = resLong,
                    function(x)ad.test(x, distr.fun = punif)$p.value)

valAnal$n<-as.factor(valAnal$n)
ggplot(valAnal, aes(y=pVal, col=method, group=method, x=n))+
  geom_point()+geom_line()+
  geom_hline(yintercept = 0.05)+
  facet_wrap(vars(var))+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```

<!-- Tom: ok tale velikost testa mi je mal tko k nic posebnega ne pokaze
ker vrednosti skoz gor pa dol skacejo...
-->

# Velikost testa

```{r}
st_ponovitev = 1000
velikost = c(10, 20, 30, 50, seq(100, 500, 50))

settings2 = expand.grid(i=1:st_ponovitev, n = velikost, var = "1,1,1")

if(file.exists("velikost_testa.RDS")){
  resV<-readRDS("velikost_testa.RDS")
} else {
  resV<-cbind(settings2, vel_ANOVA=NA, vel_ANOVA_2=NA, vel_METHOD3=NA)
  for(row in 1:nrow(settings2)){
    velikost = settings2$n[row]
    var_skupaj = as.numeric(strsplit(as.character(settings2$var[row]),",")[[1]])
    sd1 = sqrt(var_skupaj[1])
    sd2 = sqrt(var_skupaj[2])
    sd3 = sqrt(var_skupaj[3])
    
    x<-c(rnorm(velikost, 0, sd1),
         rnorm(velikost, 0, sd2),
         rnorm(velikost, 0, sd3))
    gr<-factor(rep(1:3, times=c(velikost,velikost,velikost)))
    
    resV$vel_ANOVA[row] = summary(aov(x~gr))[[1]][["Pr(>F)"]][1]
    resV$vel_ANOVA_2[row] = oneway.test(x~gr, var.equal = FALSE)$p.value
    
    p_test_enak_V = leveneTest(x~gr)$`Pr(>F)`[1]
    if(p_test_enak_V > 0.05){
      resV$vel_METHOD3[row] = summary(aov(x~gr))[[1]][["Pr(>F)"]][1]
    } else {
      resV$vel_METHOD3[row] = oneway.test(x~gr, var.equal = FALSE)$p.value
    }
  }
  saveRDS(object = resV, file="velikost_testa.RDS")
}

```


```{r}
resVLong = pivot_longer(resV, cols=matches("^vel_[AM]"), values_to = "velikost",
                       names_to = "method", names_prefix = "vel_")

valAnal_V = aggregate(velikost ~ n + method , data = resVLong,
                    function(x)mean(x<0.05))

valAnal_V$n<-as.factor(valAnal_V$n)
ggplot(valAnal_V, aes(y=velikost, col=method, group=method, x=n))+
  geom_point()+geom_smooth(se=F)+
  geom_hline(yintercept = 0.05)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

valAnal_V$n<-as.factor(valAnal_V$n)
ggplot(valAnal_V, aes(y=velikost, col=method, group=method, x=n))+
  geom_point()+geom_line()+
  geom_hline(yintercept = 0.05)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

```



